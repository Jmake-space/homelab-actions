name: k3s-node-alert

on:
  repository_dispatch:
    types: [k3s-node-alert]
  workflow_dispatch:
    inputs:
      payload_json:
        description: "Optional JSON payload for test runs"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  notify:
    runs-on: [self-hosted]
    steps:
      - name: Send email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import smtplib
          from email.message import EmailMessage

          payload = os.environ.get("PAYLOAD")
          if not payload or payload == "null":
              payload = os.environ.get("PAYLOAD_INPUT") or "{}"
          data = json.loads(payload)

          cluster = data.get("cluster", "")
          event = data.get("event", "test")
          status = data.get("status", "")
          nodes_down = data.get("nodes_down", "")
          nodes_down_current = data.get("nodes_down_current", "")
          nodes_recovered = data.get("nodes_recovered", "")
          timestamp = data.get("timestamp", "")
          nodes_table = data.get("nodes_table", "")

          if event in ("resolved", "recovery") or status == "node-recovered":
              alert_label = "RECOVERY"
              summary = f"Recovered nodes: {nodes_recovered or 'none'}"
          elif event == "incident" or status == "node-down":
              alert_label = "INCIDENT"
              summary = f"Newly down nodes: {nodes_down or 'none'}"
          else:
              alert_label = "CHANGE"
              summary = "Node state change detected"

          subject = f"[{alert_label}] k3s {cluster} - {status}"
          body = "\n".join(
              [
                  f"Cluster: {cluster}",
                  f"Alert Type: {alert_label}",
                  f"Event: {event}",
                  f"Status: {status}",
                  f"Summary: {summary}",
                  f"Down (new): {nodes_down}",
                  f"Down (current): {nodes_down_current}",
                  f"Recovered: {nodes_recovered}",
                  f"Time: {timestamp}",
                  "",
                  "Nodes:",
                  nodes_table,
              ]
          )

          msg = EmailMessage()
          msg["Subject"] = subject
          msg["From"] = os.environ["MAIL_FROM"]
          msg["To"] = os.environ["MAIL_TO"]
          msg.set_content(body)

          host = os.environ["SMTP_HOST"]
          port = int(os.environ["SMTP_PORT"])
          user = os.environ["SMTP_USER"]
          password = os.environ["SMTP_PASS"]

          with smtplib.SMTP_SSL(host, port) as smtp:
              smtp.login(user, password)
              smtp.send_message(msg)
          PY

  notify-k3s-ops-agent:
    runs-on: [self-hosted]
    needs: notify
    if: ${{ always() }}
    steps:
      - name: Forward event to k3s-ops-agent dispatch
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
          PAYLOAD_INPUT: ${{ github.event.inputs.payload_json }}
          OPS_DISPATCH_URL: ${{ vars.K3S_OPS_DISPATCH_URL || 'https://api.github.com/repos/Jmake-space/k3s-cluster/dispatches' }}
          OPS_EVENT_TYPE: ${{ vars.K3S_OPS_EVENT_TYPE || 'k3s-ops-agent-alert' }}
          OPS_DISPATCH_TOKEN: ${{ secrets.K3S_OPS_REPO_DISPATCH_TOKEN }}
          SOURCE_REPO: ${{ github.repository }}
          SOURCE_WORKFLOW: ${{ github.workflow }}
          SOURCE_RUN_ID: ${{ github.run_id }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          token = (os.environ.get("OPS_DISPATCH_TOKEN") or "").strip()
          dispatch_url = (os.environ.get("OPS_DISPATCH_URL") or "").strip()
          dispatch_event_type = (os.environ.get("OPS_EVENT_TYPE") or "k3s-ops-agent-alert").strip()
          payload_raw = os.environ.get("PAYLOAD")
          if not payload_raw or payload_raw == "null":
              payload_raw = os.environ.get("PAYLOAD_INPUT") or "{}"

          if not token or not dispatch_url:
              print("k3s-ops forward skipped: missing token or dispatch URL")
              sys.exit(0)

          payload = json.loads(payload_raw)
          payload["source"] = {
              "repo": os.environ.get("SOURCE_REPO", ""),
              "workflow": os.environ.get("SOURCE_WORKFLOW", ""),
              "run_id": os.environ.get("SOURCE_RUN_ID", ""),
          }
          body = {
              "event_type": dispatch_event_type,
              "client_payload": payload,
          }

          request = urllib.request.Request(
              dispatch_url,
              data=json.dumps(body).encode("utf-8"),
              headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"token {token}",
                  "Content-Type": "application/json",
              },
              method="POST",
          )
          with urllib.request.urlopen(request, timeout=15) as response:
              print(f"k3s-ops dispatch forwarded: status={response.status}")
          PY
